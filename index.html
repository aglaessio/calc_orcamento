<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora de Or√ßamento</title>
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --accent:#06b6d4; --accent-hover:#0891b2; --muted:#9aa4b2; --glass: rgba(255,255,255,0.03);
      --radius:16px; --gap:16px; --shadow:0 10px 40px rgba(2,6,23,0.8);
    }
    *{box-sizing:border-box;font-family:'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif}
    body{margin:0;background:linear-gradient(135deg,#071025 0%, #0a1a2e 100%);color:#e6eef6;padding:16px;min-height:100vh}
    .container{max-width:1100px;margin:0 auto;width:100%}
    .card{background:linear-gradient(145deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));border-radius:var(--radius);padding:20px;box-shadow:var(--shadow);border:1px solid rgba(255,255,255,0.03)}
    h1{margin:0 0 20px;font-size:clamp(20px, 5vw, 24px);font-weight:700;background:linear-gradient(90deg, #06b6d4, #0ea5e9);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .flex{display:flex;gap:var(--gap)}
    .col{flex:1}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:8px;font-weight:500}
    input[type="text"], input[type="number"], textarea, select{width:100%;padding:12px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:var(--glass);color:inherit;transition: all 0.2s;font-size:14px}
    input:focus, textarea:focus, select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(6, 182, 212, 0.15)}
    table{width:100%;border-collapse:collapse;margin-top:16px;font-size:14px}
    th,td{padding:10px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.05)}
    th{font-size:12px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
    .small{font-size:13px;color:var(--muted)}
    .btn{display:inline-flex;align-items:center;gap:6px;padding:12px 16px;border-radius:10px;background:var(--accent);color:#07202a;text-decoration:none;font-weight:600;border:none;cursor:pointer;transition:all 0.2s;font-size:14px;white-space:nowrap}
    .btn:hover{background:var(--accent-hover);transform:translateY(-2px);box-shadow:0 4px 12px rgba(6, 182, 212, 0.3)}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--muted)}
    .btn.ghost:hover{background:rgba(255,255,255,0.05);transform:translateY(-2px);box-shadow:0 4px 12px rgba(255,255,255,0.1)}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .totals{background:linear-gradient(145deg, rgba(255,255,255,0.02), rgba(0,0,0,0.05));padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .item-actions{display:flex;gap:6px}
    .small-btn{display:inline-flex;align-items:center;gap:4px;padding:5px 8px;border-radius:8px;border:none;background:rgba(255,255,255,0.03);cursor:pointer;transition:background 0.2s;color:var(--muted);font-size:11px;white-space:nowrap}
    .small-btn:hover{background:rgba(255,255,255,0.08)}
    .empty-state{text-align:center;padding:24px;color:var(--muted);font-style:italic;background:rgba(255,255,255,0.02);border-radius:10px;font-size:14px}
    .notification{position:fixed;top:16px;right:16px;padding:12px 16px;background:var(--card);border-radius:10px;box-shadow:var(--shadow);z-index:1000;display:none;border-left:4px solid var(--accent);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.05);max-width:calc(100vw - 32px)}
    .notification.show{display:block;animation:fadeInOut 3s ease-in-out}
    @keyframes fadeInOut{0%{opacity:0;transform:translateY(-10px)}20%{opacity:1;transform:translateY(0)}80%{opacity:1}100%{opacity:0;transform:translateY(-10px)}}
    .section-title{font-size:16px;font-weight:600;margin:20px 0 12px;color:#e6eef6;display:flex;align-items:center;gap:8px}
    .section-title::before{content:'';display:block;width:4px;height:16px;background:var(--accent);border-radius:2px}
    .total-row{font-size:18px;font-weight:700;color:#e6eef6}
    .highlight{color:var(--accent)}
    .input-group{display:flex;flex-direction:column;gap:var(--gap)}
    .divider{height:1px;background:linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);margin:16px 0;border:none}
    
    /* Container de Observa√ß√µes e Totais - Melhorado */
    .obs-totals-container {
      display: flex;
      gap: 16px;
      margin-top: 16px;
      align-items: flex-start;
    }
    
    .obs-container {
      flex: 1;
      min-width: 0;
    }
    
    .totals-container {
      min-width: 300px;
      width: 100%;
    }
    
    /* Responsividade */
    @media (max-width: 768px) {
      body{padding:12px}
      .card{padding:16px}
      
      .flex{flex-direction:column;gap:12px}
      
      table{display:block;overflow-x:auto;white-space:nowrap;font-size:13px}
      
      th, td{padding:8px 6px}
      
      .actions{justify-content:space-between;width:100%}
      
      .btn{font-size:13px;padding:10px 14px}
      
      .totals{width:100%}
      
      .item-actions{flex-direction:column;gap:4px}
      .small-btn{padding:4px 6px;font-size:10px}
      
      .section-title{font-size:15px;margin:16px 0 10px}
      
      /* Ajustes espec√≠ficos para o container de observa√ß√µes e totais */
      .obs-totals-container {
        flex-direction: column;
        gap: 16px;
      }
      
      .totals-container {
        min-width: 100%;
        order: -1; /* Coloca os totais antes das observa√ß√µes em mobile */
      }
      
      .obs-container {
        width: 100%;
      }
    }
    
    @media (max-width: 480px) {
      body{padding:8px}
      .card{padding:12px}
      
      h1{font-size:18px}
      
      .btn{width:100%;justify-content:center}
      
      .actions{flex-direction:column;gap:8px}
      .actions .btn{width:100%}
      
      th, td{padding:6px 4px;font-size:12px}
      
      input[type="text"], input[type="number"], textarea, select{padding:10px 12px;font-size:13px}
      
      .notification{top:12px;right:12px;left:12px;max-width:none}
      
      /* Ajustes adicionais para telas muito pequenas */
      .obs-totals-container {
        gap: 12px;
      }
      
      .totals {
        padding: 12px;
      }
    }
    
    @media (max-width: 360px) {
      .card{padding:10px}
      
      h1{font-size:16px}
      
      .btn{padding:8px 12px;font-size:12px}
      
      th, td{padding:4px 3px;font-size:11px}
      
      .section-title{font-size:14px}
      
      .total-row{font-size:16px}
      
      .obs-totals-container {
        gap: 10px;
      }
    }
    
    .print-only{display:none}
    @media print{
      body{background:white;color:black;padding:0}
      .card{box-shadow:none;border:1px solid #ddd}
      .btn{display:none}
      .print-only{display:block}
      .notification{display:none!important}
    }
  </style>
</head>
<body>
  <div class="notification" id="notification"></div>
  
  <div class="container">
    <div class="card">
      <h1>üíº Calculadora de Or√ßamento</h1>

      <div class="flex" style="margin-top:16px">
        <div class="col">
          <label>üè¢ Minha empresa</label>
          <input id="company" type="text" placeholder="Nome da sua empresa" />
        </div>
        <div class="col">
          <label>üë§ Cliente</label>
          <input id="client" type="text" placeholder="Nome do cliente" />
        </div>
        <div style="min-width:150px">
          <label>‚è±Ô∏è Validade (dias)</label>
          <input id="validity" type="number" min="1" value="7" />
        </div>
      </div>

      <div class="divider"></div>

      <div>
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px">
          <h3 class="section-title">üìã Itens do Or√ßamento</h3>
          <div class="actions">
            <button id="addItem" class="btn">‚ûï Adicionar item</button>
            <button id="clearItems" class="btn ghost">üóëÔ∏è Limpar</button>
          </div>
        </div>

        <div style="overflow-x:auto">
          <table id="itemsTable" aria-live="polite">
            <thead>
              <tr>
                <th>Descri√ß√£o</th>
                <th style="min-width:80px">Qtd</th>
                <th style="min-width:120px">Pre√ßo unit.</th>
                <th style="min-width:100px">Sub-total</th>
                <th style="min-width:100px">A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="itemsBody">
              <!-- itens ser√£o inseridos aqui -->
            </tbody>
          </table>
        </div>
      </div>

      <div class="flex" style="margin-top:16px">
        <div style="flex:1;min-width:0">
          <label>üìä Imposto (%)</label>
          <input id="tax" type="number" min="0" value="0" step="0.1" />
        </div>
        <div style="min-width:150px">
          <label>üí∏ Desconto (%)</label>
          <input id="discount" type="number" min="0" value="0" step="0.1" />
        </div>
        <div style="min-width:200px">
          <label>üìû Telefone do cliente (opcional)</label>
          <input id="phone" type="text" placeholder="5511999887766" />
        </div>
      </div>

      <!-- Observa√ß√µes movida para depois do telefone -->
      <div style="margin-top:16px">
        <label>üìù Observa√ß√µes</label>
        <textarea id="notes" rows="4" placeholder="Observa√ß√µes sobre o or√ßamento"></textarea>
      </div>

      <!-- Container dos totais -->
      <div class="totals-container" style="margin-top:16px">
        <div class="totals">
          <div style="display:flex;justify-content:space-between"><div class="muted">Subtotal</div><div id="subtotal">R$¬†0,00</div></div>
          <div style="display:flex;justify-content:space-between"><div class="muted">Imposto</div><div id="taxAmount">R$¬†0,00</div></div>
          <div style="display:flex;justify-content:space-between"><div class="muted">Desconto</div><div id="discountAmount">R$¬†0,00</div></div>
          <div class="divider"></div>
          <div style="display:flex;justify-content:space-between;font-weight:700;font-size:18px" class="total-row"><div>Total</div><div id="total">R$¬†0,00</div></div>

          <div style="margin-top:16px;display:flex;gap:8px;flex-wrap:wrap">
            <button id="copyBtn" class="btn ghost" title="Copiar resumo">üìã Copiar</button>
            <button id="printBtn" class="btn ghost" title="Imprimir">üñ®Ô∏è Imprimir</button>
            <button id="saveBtn" class="btn ghost" title="Salvar">üíæ Salvar</button>
            <button id="whatsappBtn" class="btn">üì± WhatsApp</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Utilit√°rios
    const fmt = v => new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v);
    
    // Fun√ß√£o para mostrar notifica√ß√µes
    function showNotification(message, duration = 3000) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, duration);
    }
    
    // Fun√ß√£o para escapar HTML
    function escapeHtml(text) { 
      return String(text||'').replace(/[&<>\"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;" }[c])); 
    }

    // Fun√ß√£o para copiar texto para a √°rea de transfer√™ncia
    function copyToClipboard(text) {
      return new Promise((resolve, reject) => {
        // M√©todo moderno usando Clipboard API
        if (navigator.clipboard && window.isSecureContext) {
          navigator.clipboard.writeText(text)
            .then(() => resolve(true))
            .catch(err => {
              console.error('Erro ao copiar com Clipboard API:', err);
              // Fallback para m√©todo antigo
              fallbackCopyTextToClipboard(text, resolve, reject);
            });
        } else {
          // Fallback para m√©todo antigo
          fallbackCopyTextToClipboard(text, resolve, reject);
        }
      });
    }

    // Fallback para navegadores mais antigos
    function fallbackCopyTextToClipboard(text, resolve, reject) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.opacity = '0';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        const successful = document.execCommand('copy');
        document.body.removeChild(textArea);
        if (successful) {
          resolve(true);
        } else {
          reject(new Error('Falha ao copiar texto'));
        }
      } catch (err) {
        document.body.removeChild(textArea);
        reject(err);
      }
    }

    // Estado
    let items = [];

    // Elementos DOM
    const elements = {
      itemsBody: document.getElementById('itemsBody'),
      subtotal: document.getElementById('subtotal'),
      tax: document.getElementById('tax'),
      taxAmount: document.getElementById('taxAmount'),
      discount: document.getElementById('discount'),
      discountAmount: document.getElementById('discountAmount'),
      total: document.getElementById('total'),
      company: document.getElementById('company'),
      client: document.getElementById('client'),
      phone: document.getElementById('phone'),
      notes: document.getElementById('notes'),
      validity: document.getElementById('validity'),
      addItem: document.getElementById('addItem'),
      clearItems: document.getElementById('clearItems'),
      copyBtn: document.getElementById('copyBtn'),
      printBtn: document.getElementById('printBtn'),
      saveBtn: document.getElementById('saveBtn'),
      whatsappBtn: document.getElementById('whatsappBtn')
    };

    // Valida√ß√£o de entrada num√©rica
    function validateNumberInput(input, min = 0, max = Infinity) {
      let value = parseFloat(input.value) || 0;
      if (value < min) value = min;
      if (value > max) value = max;
      input.value = value;
      return value;
    }

    // Cria uma linha de item na tabela
    function createRow(item, idx) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input class="desc" data-idx="${idx}" type="text" value="${escapeHtml(item.desc)}" placeholder="Descri√ß√£o" /></td>
        <td><input class="qty" data-idx="${idx}" type="number" min="0" step="1" value="${item.qty}" /></td>
        <td><input class="price" data-idx="${idx}" type="number" min="0" step="0.01" value="${item.price}" /></td>
        <td class="right item-subtotal">${fmt(item.qty * item.price)}</td>
        <td class="item-actions">
          <button class="small-btn del" data-idx="${idx}" title="Remover item">üóëÔ∏è</button>
          <button class="small-btn duplicate" data-idx="${idx}" title="Duplicar item">üìã</button>
        </td>
      `;

      // Handlers para inputs - agora atualizam apenas a linha espec√≠fica
      tr.querySelectorAll('input').forEach(inp => {
        inp.addEventListener('input', e => {
          const i = Number(e.target.dataset.idx);
          if (e.target.classList.contains('desc')) {
            items[i].desc = e.target.value;
          }
          if (e.target.classList.contains('qty')) {
            items[i].qty = validateNumberInput(e.target, 0);
          }
          if (e.target.classList.contains('price')) {
            items[i].price = validateNumberInput(e.target, 0);
          }
          // Atualiza apenas o subtotal desta linha
          updateRowSubtotal(i);
          // Atualiza totais gerais
          updateTotals();
          saveToLocalStorage();
        });
        
        // Foco no pr√≥ximo campo ao pressionar Enter
        inp.addEventListener('keydown', e => {
          if (e.key === 'Enter') {
            const inputs = Array.from(tr.querySelectorAll('input'));
            const currentIndex = inputs.indexOf(e.target);
            if (currentIndex < inputs.length - 1) {
              inputs[currentIndex + 1].focus();
            } else {
              // Se for o √∫ltimo campo, adiciona um novo item
              addNewItem();
            }
          }
        });
      });
      
      // Handler para remover item
      tr.querySelector('.del').addEventListener('click', () => { 
        items.splice(idx, 1); 
        renderTable();
        showNotification('Item removido');
      });
      
      // Handler para duplicar item
      tr.querySelector('.duplicate').addEventListener('click', () => { 
        const originalItem = items[idx];
        items.splice(idx + 1, 0, {...originalItem});
        renderTable();
        showNotification('Item duplicado');
      });

      return tr;
    }

    // Atualiza apenas o subtotal de uma linha espec√≠fica
    function updateRowSubtotal(idx) {
      const row = elements.itemsBody.children[idx];
      if (!row) return;
      
      const item = items[idx];
      const subtotalCell = row.querySelector('.item-subtotal');
      if (subtotalCell) {
        subtotalCell.textContent = fmt(item.qty * item.price);
      }
    }

    // Renderiza apenas a tabela (quando a estrutura muda)
    function renderTable() {
      // Limpa e reconstr√≥i a tabela
      elements.itemsBody.innerHTML = '';
      
      if (items.length === 0) {
        elements.itemsBody.innerHTML = `
          <tr>
            <td colspan="5" class="empty-state">
              üìù Nenhum item adicionado. Clique em "Adicionar item" para come√ßar.
            </td>
          </tr>
        `;
      } else {
        items.forEach((it, i) => elements.itemsBody.appendChild(createRow(it, i)));
      }
      
      // Atualiza totais
      updateTotals();
    }

    // Atualiza apenas os totais
    function updateTotals() {
      // Calcula totais
      const subtotal = items.reduce((s, it) => s + (it.qty * it.price), 0);
      const taxPerc = Number(elements.tax.value) || 0;
      const discountPerc = Number(elements.discount.value) || 0;
      const taxAmount = subtotal * (taxPerc / 100);
      const discountAmount = subtotal * (discountPerc / 100);
      const total = subtotal + taxAmount - discountAmount;

      // Atualiza elementos de exibi√ß√£o
      elements.subtotal.textContent = fmt(subtotal);
      elements.taxAmount.textContent = fmt(taxAmount);
      elements.discountAmount.textContent = fmt(discountAmount);
      elements.total.textContent = fmt(total >= 0 ? total : 0);
    }

    // Adiciona um novo item
    function addNewItem() {
      items.push({ desc: '', qty: 1, price: 0 });
      renderTable();
      
      // Foca no campo de descri√ß√£o do novo item
      setTimeout(() => {
        const lastInput = elements.itemsBody.lastElementChild?.querySelector('.desc');
        if (lastInput) lastInput.focus();
      }, 10);
    }

    // Constr√≥i o texto do resumo para WhatsApp
    function buildSummaryText() {
      const company = elements.company.value || 'N√£o informado';
      const client = elements.client.value || 'N√£o informado';
      const validity = Number(elements.validity.value) || 7;
      const notes = elements.notes.value || 'Nenhuma observa√ß√£o adicional.';

      const subtotal = items.reduce((s, it) => s + (it.qty * it.price), 0);
      const taxPerc = Number(elements.tax.value) || 0;
      const discountPerc = Number(elements.discount.value) || 0;
      const taxAmount = subtotal * (taxPerc / 100);
      const discountAmount = subtotal * (discountPerc / 100);
      const total = subtotal + taxAmount - discountAmount;

      // Usar emojis mais compat√≠veis e garantir codifica√ß√£o UTF-8
      let text = "";
      
      // Cabe√ßalho
      text += `*OR√áAMENTO* üìã\n`;
      text += `==============================\n\n`;
      
      // Informa√ß√µes b√°sicas
      text += `*Empresa:* ${company} üè¢\n`;
      text += `*Cliente:* ${client} üë§\n`;
      text += `*Validade:* ${validity} dias √∫teis ‚è≥\n\n`;
      
      // Itens do or√ßamento
      if (items.length > 0) {
        text += `*ITENS OR√áADOS* üì¶\n`;
        text += `==============================\n`;
        
        items.forEach((it, i) => {
          const itemTotal = it.qty * it.price;
          text += `${i + 1}. ${it.desc || 'Item sem descri√ß√£o'}\n`;
          text += `   ‚Ä¢ Quantidade: ${it.qty}\n`;
          text += `   ‚Ä¢ Pre√ßo unit√°rio: ${fmt(it.price)}\n`;
          text += `   ‚Üí Subtotal: ${fmt(itemTotal)}\n\n`;
        });
      }
      
      // Resumo financeiro
      text += `*RESUMO FINANCEIRO* üí∞\n`;
      text += `==============================\n`;
      text += `Subtotal: ${fmt(subtotal)}\n`;
      
      if (taxPerc > 0) {
        text += `Imposto (${taxPerc}%): ${fmt(taxAmount)}\n`;
      }
      
      if (discountPerc > 0) {
        text += `Desconto (${discountPerc}%): ${fmt(discountAmount)}\n`;
      }
      
      text += `\n`;
      text += `*VALOR TOTAL: ${fmt(total >= 0 ? total : 0)}* üíµ\n\n`;
      
      // Observa√ß√µes
      text += `*OBSERVA√á√ïES* üìù\n`;
      text += `==============================\n`;
      text += `${notes}\n\n`;
      
      // Rodap√©
      text += `Este or√ßamento foi gerado automaticamente e possui validade de ${validity} dias.\n\n`;
      text += `Data de emiss√£o: ${new Date().toLocaleDateString('pt-BR')} üìÖ\n`;
      text += `Hor√°rio: ${new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})} üïí\n\n`;
      text += `Agradecemos sua prefer√™ncia! üôè`;
      
      return text;
    }

    // Salva dados no localStorage
    function saveToLocalStorage() {
      const data = {
        company: elements.company.value,
        client: elements.client.value,
        validity: elements.validity.value,
        tax: elements.tax.value,
        discount: elements.discount.value,
        phone: elements.phone.value,
        notes: elements.notes.value,
        items: items
      };
      localStorage.setItem('budgetCalculatorData', JSON.stringify(data));
    }

    // Carrega dados do localStorage
    function loadFromLocalStorage() {
      const savedData = localStorage.getItem('budgetCalculatorData');
      if (savedData) {
        try {
          const data = JSON.parse(savedData);
          elements.company.value = data.company || '';
          elements.client.value = data.client || '';
          elements.validity.value = data.validity || 7;
          elements.tax.value = data.tax || 0;
          elements.discount.value = data.discount || 0;
          elements.phone.value = data.phone || '';
          elements.notes.value = data.notes || '';
          items = data.items || [];
          renderTable();
          showNotification('Dados recuperados do armazenamento local');
        } catch (e) {
          console.error('Erro ao carregar dados salvos:', e);
        }
      }
    }

    // Exporta dados para arquivo
    function exportData() {
      const data = {
        company: elements.company.value,
        client: elements.client.value,
        validity: elements.validity.value,
        tax: elements.tax.value,
        discount: elements.discount.value,
        phone: elements.phone.value,
        notes: elements.notes.value,
        items: items,
        summary: buildSummaryText(),
        timestamp: new Date().toISOString()
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `orcamento-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showNotification('Or√ßamento salvo como arquivo');
    }

    // Abre o WhatsApp com a mensagem pr√©-preenchida
    function openWhatsAppWithMessage() {
      const phone = (elements.phone.value || '').replace(/\D/g, '');
      const text = buildSummaryText();
      
      // Codificar o texto para URL
      const encodedText = encodeURIComponent(text);
      
      let url = '';
      
      if (phone.length >= 8) {
        // Se tem telefone, abre conversa espec√≠fica com mensagem
        url = `https://wa.me/${phone}?text=${encodedText}`;
      } else {
        // Se n√£o tem telefone, abre WhatsApp com mensagem pronta
        url = `https://wa.me/?text=${encodedText}`;
      }
      
      // Abre em uma nova janela
      const newWindow = window.open(url, '_blank');
      
      if (newWindow) {
        showNotification('WhatsApp aberto com a mensagem pr√©-preenchida!');
      } else {
        showNotification('WhatsApp aberto! A mensagem foi copiada para sua √°rea de transfer√™ncia.');
        
        // Se a janela n√£o abriu, copia para √°rea de transfer√™ncia como fallback
        copyToClipboard(text)
          .then(() => {
            showNotification('Mensagem copiada! Cole no WhatsApp (Ctrl+V).');
          })
          .catch(err => {
            console.error('Erro ao copiar:', err);
            showNotification('Erro ao copiar automaticamente. Copie manualmente a mensagem.');
          });
      }
    }

    // Event Listeners
    elements.addItem.addEventListener('click', addNewItem);
    
    elements.clearItems.addEventListener('click', () => { 
      if (items.length === 0 || confirm('Tem certeza que deseja limpar todos os itens?')) { 
        items = []; 
        renderTable();
        showNotification('Todos os itens foram removidos');
      }
    });
    
    elements.tax.addEventListener('input', updateTotals);
    elements.discount.addEventListener('input', updateTotals);
    
    elements.copyBtn.addEventListener('click', () => {
      const summary = buildSummaryText();
      copyToClipboard(summary)
        .then(() => {
          showNotification('Resumo copiado para a √°rea de transfer√™ncia!');
        })
        .catch(err => {
          console.error('Erro ao copiar:', err);
          showNotification('Erro ao copiar. Tente novamente ou use Ctrl+C manualmente.');
        });
    });

    elements.printBtn.addEventListener('click', () => {
      window.print();
    });
    
    elements.saveBtn.addEventListener('click', exportData);

    elements.whatsappBtn.addEventListener('click', () => {
      openWhatsAppWithMessage();
    });

    // Inicializa√ß√£o
    function init() {
      // Carrega dados salvos
      loadFromLocalStorage();
      
      // Adiciona um item de exemplo se n√£o houver dados salvos
      if (items.length === 0) {
        items.push({ desc: 'Servi√ßo de exemplo', qty: 1, price: 150.00 });
        renderTable();
      }
      
      // Adiciona evento para salvar automaticamente quando campos s√£o alterados
      ['company', 'client', 'validity', 'phone', 'notes'].forEach(id => {
        document.getElementById(id).addEventListener('input', saveToLocalStorage);
      });
    }

    // Inicia a aplica√ß√£o
    init();
  </script>
</body>
</html>